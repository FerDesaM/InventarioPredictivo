{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Predictivo - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'inventario/css/styles.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-pills"></i>
                <h1>Inventario Predictivo</h1>
            </div>
            <div class="user-info">
                <div class="notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count">3</span>
                </div>
                <div class="user-profile">
                    <img src="https://via.placeholder.com/40" alt="Usuario">
                    <span>Admin Farmacia</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active">
                    <a href="#dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#inventario">
                        <i class="fas fa-boxes"></i>
                        <span>Inventario</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#compras">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Compras</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#prediccion">
                        <i class="fas fa-chart-line"></i>
                        <span>Predicción</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#caducidad">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Caducidad</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#transferencias">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Transferencias</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#empleados">
                        <i class="fas fa-users"></i>
                        <span>Empleados</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <h2>Dashboard Principal</h2>
                <div class="date-filter">
                    <select>
                        <option>Últimos 7 días</option>
                        <option>Últimos 30 días</option>
                        <option>Último mes</option>
                    </select>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ stats.total_productos }}</h3>
                        <p>Productos en Stock</p>
                        <span class="stat-change positive">+5.2%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ stats.stock_bajo }}</h3>
                        <p>Stock Bajo</p>
                        <span class="stat-change negative">+12</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ stats.proximos_vencer }}</h3>
                        <p>Próximos a Vencer</p>
                        <span class="stat-change negative">+8</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>${{ stats.ventas_mes }}</h3>
                        <p>Ventas del Mes</p>
                        <span class="stat-change positive">+8.7%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ stats.compras_mes }}</h3>
                        <p>Compras del Mes</p>
                        <span class="stat-change positive">+{{ stats.compras_pendientes }} pendientes</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3>${{ stats.total_compras_mes|floatformat:2 }}</h3>
                        <p>Inversión en Compras</p>
                        <span class="stat-change positive">+8.7%</span>
                    </div>
                </div>
            </div>

            <!-- Charts and Tables -->
            <div class="dashboard-grid">
                <div class="chart-container">
                    <h3>Ventas por Mes</h3>
                    <div class="chart-placeholder">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="alerts-container">
                    <h3>Alertas Recientes</h3>
                    <div class="alerts-list">
                        {% for alerta in alertas %}
                        <div class="alert-item {{ alerta.tipo }}">
                            <i class="fas fa-exclamation-circle"></i>
                            <div class="alert-content">
                                <p>{{ alerta.mensaje }}</p>
                                <span>{{ alerta.tiempo }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

    
      <!-- Sección Compras -->
      <section id="compras" class="content-section">
        <div class="section-header">
          <h2>Gestión de Compras</h2>
          <button class="btn btn-primary" onclick="mostrarForm('nueva')">
            <i class="fas fa-plus"></i> Nueva Compra
          </button>
        </div>

        <!-- Listado -->
        <div id="listado-compras">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th><th>Producto</th><th>Farmacia</th><th>Proveedor</th>
                <th>Cant.</th><th>Precio U.</th><th>Total</th><th>Fecha</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for c in compras_recientes %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.producto.nombre_producto }}</td>
                <td>{{ c.farmacia.nombre_farmacia }}</td>
                <td>{{ c.proveedor }}</td>
                <td>{{ c.cantidad }}</td>
                <td>${{ c.precio_unitarioC|floatformat:2 }}</td>
                <td>${{ c.total_compra|floatformat:2 }}</td>
                <td>{{ c.fecha_compra|date:"d/m/Y" }}</td>
                <td>
                  <button onclick="window.location='?sección=compras&editar={{ c.id }}'">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="if(confirm('Eliminar?')) postForm('eliminar', '{{ c.id }}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="9">No hay compras registradas</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Formulario -->
<div id="form-compras" style="display:none;">
  <h3>{% if compra_editar %}Editar Compra #{{ compra_editar.id }}{% else %}Nueva Compra{% endif %}</h3>
  <form method="post" action="?seccion=compras" id="compra-form">
    {% csrf_token %}
    <input type="hidden" name="accion" value="{% if compra_editar %}editar{% else %}nueva{% endif %}">
    {% if compra_editar %}
      <input type="hidden" name="compra_id" value="{{ compra_editar.id }}">
    {% endif %}
    <label>Farmacia</label>
    <select name="farmacia" required>
      <option value="">--</option>
      {% for f in farmacias %}
      <option value="{{ f.id }}" {% if compra_editar and f.id == compra_editar.farmacia.id %}selected{% endif %}>
        {{ f.nombre_farmacia }}
      </option>
      {% endfor %}
    </select>

    <label>Producto</label>
<select name="producto" required>
  <option value="P001">--</option>
  {% for p in productos %}
  <option value="{{ p.id }}" {% if compra_editar and p.id == compra_editar.producto.id %}selected{% endif %}>{{ p.nombre_producto }}</option>
  {% endfor %}
</select>

    <label>Proveedor</label>
    <input type="text" name="proveedor" required value="{{ compra_editar.proveedor|default:'' }}">

    <label>Cantidad</label>
    <input type="number" name="cantidad" min="1" required value="{{ compra_editar.cantidad|default:'' }}">

    <label>Precio Unitario</label>
    <input type="number" step="0.01" name="precio_unitarioC" min="0" required value="{{ compra_editar.precio_unitarioC|default:'' }}">

    <label>Fecha Compra</label>
    <input type="date" name="fecha_compra"
  value="{% if compra_editar %}{{ compra_editar.fecha_compra|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
    <button type="submit" class="btn btn-success">{% if compra_editar %}Actualizar{% else %}Guardar{% endif %}</button>
    <button type="button" class="btn btn-secondary" onclick="mostrarForm('')">Cancelar</button>
  </form>
</div>
      </section>
   

    <!-- Inventario Section -->
        <section id="inventario" class="content-section">
            <div class="section-header">
                <h2>Gestión de Inventario</h2>
                <button class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Agregar Producto
                </button>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="filter-group">
                    <input type="text" placeholder="Buscar producto..." class="search-input">
                    <select class="filter-select">
                        <option>Todas las categorías</option>
                        <option>Analgésicos</option>
                        <option>Antibióticos</option>
                        <option>Vitaminas</option>
                    </select>
                    <select class="filter-select">
                        <option>Todos los proveedores</option>
                        <option>Proveedor A</option>
                        <option>Proveedor B</option>
                    </select>
                </div>
            </div>

      <!-- Inventory Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Vencimiento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventario %}
                        <tr>
                            <td>{{ item.producto.product_id }}</td>
                            <td>{{ item.producto.nombre_producto }}</td>
                            <td>{{ item.producto.clase }}</td>
                            <td class="{% if item.stock < 20 %}stock-low{% endif %}">{{ item.stock }}</td>
                            <td>${{ item.producto.precio_unitario }}</td>
                            <td>{{ item.producto.fecha_vencimiento }}</td>
                            <td>
                                {% if item.stock < 20 %}
                                <span class="status-badge warning">Stock Bajo</span>
                                {% elif item.producto.fecha_vencimiento < today %}
                                <span class="status-badge danger">Vencido</span>
                                {% else %}
                                <span class="status-badge success">Normal</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-icon"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
<script>
  const formDiv = document.getElementById('form-compras');
  const listDiv = document.getElementById('listado-compras');

  // Variable booleana que indica si hay compra para editar
  const COMPRA_EDITAR = '{{ compra_editar|yesno:"true,false" }}';

  function mostrarForm(accion) {
    if (accion === 'nueva' || COMPRA_EDITAR) {
      listDiv.style.display = 'none';
      formDiv.style.display = 'block';
    } else {
      formDiv.style.display = 'none';
      listDiv.style.display = 'block';
    }
  }

  // Obtiene token CSRF del DOM para los formularios creados dinámicamente en JS
  function getCsrfToken() {
    const csrfElem = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfElem ? csrfElem.value : '';
  }

  // Función para eliminar o editar usando un formulario dinámico POST con CSRF
  function postForm(accion, id) {
    const f = document.createElement('form');
    f.method = 'post';
    f.action = ''; // Envía a la misma URL actual con parámetros GET intactos
    const csrfToken = getCsrfToken();
    f.innerHTML = `
      <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
      <input type="hidden" name="accion" value="${accion}">
      <input type="hidden" name="compra_id" value="${id}">
    `;
    document.body.appendChild(f);
    f.submit();
  }

  // Al cargar la página, si estamos editando, mostrar el formulario directamente
  window.onload = function() {
    if (COMPRA_EDITAR) {
      mostrarForm('editar');
    }
  }
</script>

        <section id="prediccion" class="content-section">
            <div class="section-header mb-3">
                <h2>Predicción Inteligente</h2>
            </div>

            <!-- Selector de producto y botón en una fila -->
            <div class="d-flex align-items-end gap-2 flex-wrap mb-4">
                <div>
                    <label for="productoSelect" class="form-label">Selecciona un producto:</label>
                    <select id="productoSelect" class="form-select w-auto">
                        <option value="">-- Selecciona --</option>
                        {% for p in productos %}
                        <option value="{{ p.nombre_producto }}">{{ p.nombre_producto }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button id="btnPredecir" class="btn btn-primary">Predecir</button>
                </div>
            </div>

            <!-- Aquí se mostrarán los resultados -->
            <div id="resultado-prediccion"></div>
            <div id="grafico-ventas-container" class="mt-4"></div>
        </section>

        
        
        

        <!-- Caducidad Section -->
        <section id="caducidad" class="content-section">
            <div class="section-header">
                <h2>Gestión de Caducidad</h2>
                <button class="btn btn-warning">Generar Ofertas</button>
            </div>

            <div class="expiry-grid">
                <div class="expiry-alerts">
                    <h3>Productos Próximos a Vencer</h3>
                    <div class="expiry-list">
                        <div class="expiry-item urgent">
                            <div class="product-details">
                                <h4>Ibuprofeno 400mg</h4>
                                <p>Lote: IBU2024-08</p>
                                <p>Vence: 2025-08-20 (15 días)</p>
                                <p>Stock: 120 unidades</p>
                            </div>
                            <div class="expiry-actions">
                                <button class="btn btn-warning btn-sm">Crear Oferta</button>
                                <button class="btn btn-info btn-sm">Transferir</button>
                            </div>
                        </div>
                        <div class="expiry-item warning">
                            <div class="product-details">
                                <h4>Amoxicilina 500mg</h4>
                                <p>Lote: AMX2024-09</p>
                                <p>Vence: 2025-09-15 (25 días)</p>
                                <p>Stock: 80 unidades</p>
                            </div>
                            <div class="expiry-actions">
                                <button class="btn btn-warning btn-sm">Crear Oferta</button>
                                <button class="btn btn-info btn-sm">Transferir</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="offers-panel">
                    <h3>Ofertas Activas</h3>
                    <div class="offers-list">
                        <div class="offer-item">
                            <div class="offer-info">
                                <h4>Ibuprofeno 400mg</h4>
                                <p>Descuento: 30%</p>
                                <p>Precio original: $3.20</p>
                                <p>Precio oferta: $2.24</p>
                            </div>
                            <div class="offer-status">
                                <span class="status-badge success">Activa</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Transferencias Section -->
        <section id="transferencias" class="content-section">
            <div class="section-header">
                <h2>Transferencias entre Sucursales</h2>
                <button class="btn btn-primary">Nueva Transferencia</button>
            </div>

            <div class="transfers-container">
                <div class="transfer-form">
                    <h3>Solicitar Transferencia</h3>
                    <form class="form-grid">
                        <div class="form-group">
                            <label>Producto</label>
                            <select class="form-control">
                                <option>Seleccionar producto...</option>
                                <option>Paracetamol 500mg</option>
                                <option>Ibuprofeno 400mg</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sucursal Origen</label>
                            <select class="form-control">
                                <option>Farmacia Central</option>
                                <option>Farmacia Norte</option>
                                <option>Farmacia Sur</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sucursal Destino</label>
                            <select class="form-control">
                                <option>Farmacia Norte</option>
                                <option>Farmacia Sur</option>
                                <option>Farmacia Este</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cantidad</label>
                            <input type="number" class="form-control" placeholder="0">
                        </div>
                        <div class="form-group full-width">
                            <label>Motivo</label>
                            <textarea class="form-control" placeholder="Descripción del motivo..."></textarea>
                        </div>
                        <div class="form-actions full-width">
                            <button type="submit" class="btn btn-primary">Solicitar Transferencia</button>
                        </div>
                    </form>
                </div>

                <div class="transfers-history">
                    <h3>Historial de Transferencias</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Producto</th>
                                    <th>Origen</th>
                                    <th>Destino</th>
                                    <th>Cantidad</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-06-19</td>
                                    <td>Paracetamol 500mg</td>
                                    <td>Farmacia Central</td>
                                    <td>Farmacia Norte</td>
                                    <td>50</td>
                                    <td><span class="status-badge success">Completada</span></td>
                                </tr>
                                <tr>
                                    <td>2025-06-18</td>
                                    <td>Vitamina C 1000mg</td>
                                    <td>Farmacia Sur</td>
                                    <td>Farmacia Este</td>
                                    <td>30</td>
                                    <td><span class="status-badge warning">En Tránsito</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Empleados Section -->
        <section id="empleados" class="content-section">
            <div class="section-header mb-3">
                <h2>Ranking de Empleados por Mes y Año</h2>
            </div>
        
            <!-- Filtros -->
            <div class="mb-4">
                <label for="mesSelect">Selecciona mes:</label>
                <select id="mesSelect" class="form-select d-inline-block" style="width:auto; margin-right: 10px;">
                    <option value="">-- Mes --</option>
                    <option value="January">Enero</option>
                    <option value="February">Febrero</option>
                    <option value="March">Marzo</option>
                    <option value="April">Abril</option>
                    <option value="May">Mayo</option>
                    <option value="June">Junio</option>
                    <option value="July">Julio</option>
                    <option value="August">Agosto</option>
                    <option value="September">Septiembre</option>
                    <option value="October">Octubre</option>
                    <option value="November">Noviembre</option>
                    <option value="December">Diciembre</option>
                </select>
        
                <select id="anioSelect" class="form-select d-inline-block" style="width:auto; margin-right: 10px;">
                    <option value="">-- Año --</option>
                    {% for a in años_disponibles %}
                        <option value="{{ a }}">{{ a }}</option>
                    {% endfor %}
                </select>
        
                <button id="btnBuscarRanking" class="btn btn-primary">Aceptar</button>

            </div>
        
            <!-- Resultados -->
            <div id="tablaRankingContainer"></div>
            <div style="margin-top: 2rem;">
                <canvas id="graficoRanking" style="max-width: 1000px; height: 450px; margin: 0 auto; display: block;"></canvas>
            </div>
        </section>
        
        
        
        
    </main>

    











    <!-- Modal for Add Product -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Nuevo Producto</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form class="form-grid">
                    <div class="form-group">
                        <label>Código del Producto</label>
                        <input type="text" class="form-control" placeholder="MED001">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" class="form-control" placeholder="Paracetamol 500mg">
                    </div>
                    <div class="form-group">
                        <label>Categoría</label>
                        <select class="form-control">
                            <option>Analgésicos</option>
                            <option>Antibióticos</option>
                            <option>Vitaminas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Proveedor</label>
                        <select class="form-control">
                            <option>Proveedor A</option>
                            <option>Proveedor B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad Inicial</label>
                        <input type="number" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Precio Unitario</label>
                        <input type="number" step="0.01" class="form-control" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Vencimiento</label>
                        <input type="date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Stock Mínimo</label>
                        <input type="number" class="form-control" placeholder="10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary">Cancelar</button>
                <button class="btn btn-primary">Guardar Producto</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="{% static 'inventario/js/script.js' %}"></script>
</body>
</html>